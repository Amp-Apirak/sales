# สิทธิ์และบทบาทในระบบ (มุมมองหน้า Dashboard)

เอกสารนี้อธิบายสิทธิ์การเข้าถึงและขอบเขตข้อมูลที่ผู้ใช้แต่ละบทบาทมองเห็นบนหน้า Dashboard ตามโค้ดใน `index.php` และการตั้งค่าเซสชันหลัง Login

## ภาพรวมบทบาทและธงควบคุมสิทธิ์
- ตัวแปรสถานะสิทธิ์ (จาก `index.php`):
  - `can_view_all` — เห็นข้อมูลทั้งองค์กร (Executive)
  - `can_view_team` — เห็นข้อมูลเฉพาะ “ทีมที่ตนสังกัด” (Sale Supervisor)
  - `can_view_own` — เห็นข้อมูลเฉพาะ “ของตนเอง” (Seller, Engineer)
  - `can_view_financial` — เห็นข้อมูลการเงิน (ทั้งหมดยกเว้น Engineer)
- การกำหนดจากบทบาท:
  - Executive: `can_view_all = true`, `can_view_financial = true`
  - Sale Supervisor: `can_view_team = true`, `can_view_financial = true`
  - Seller: `can_view_own = true`, `can_view_financial = true`
  - Engineer: `can_view_own = true`, `can_view_financial = false`

## ขอบเขตข้อมูลที่เห็น (Scope)
- Executive
  - เห็นข้อมูลทุกทีม/ทุกคนได้ทั้งหมด
  - มีตัวกรองบน Dashboard: เลือกทีม (`team_select`) และผู้ใช้ (`user_select`) เพิ่มเติมจากช่วงวันที่
  - หากเลือกทีม/ผู้ใช้ ข้อมูลจะถูกจำกัดตามที่เลือก
- Sale Supervisor
  - เห็นเฉพาะข้อมูลทีมที่ตนสังกัดอยู่ (กรณีอยู่หลายทีม ระบบรองรับโหมด “ALL” เพื่อรวมทุกทีมของผู้ใช้)
  - เปลี่ยนทีมที่กำลังใช้งานได้จาก Team Switcher บน Navbar (เมื่ออยู่หลายทีม)
  - ตัวกรองบน Dashboard มีเฉพาะช่วงวันที่ (ไม่มีตัวเลือกทีม/ผู้ใช้บนฟอร์ม)
- Seller
  - เห็นเฉพาะข้อมูลโครงการของตนเอง (ผู้ขาย = user ของตน)
  - ตัวกรองบน Dashboard มีเฉพาะช่วงวันที่
- Engineer
  - เห็นเฉพาะข้อมูลของตนเอง และ “ไม่เห็น” ส่วนการเงินทั้งหมด
  - ตัวกรองบน Dashboard มีเฉพาะช่วงวันที่

## องค์ประกอบบน Dashboard ที่แต่ละบทบาทเห็นได้
- สรุป KPI เบื้องต้น (การ์ด 4 ใบแรก):
  - จำนวนทีม (label แตกต่างตามบทบาท) — ทุกบทบาทเห็น
  - จำนวนสมาชิกทีม (label แตกต่างตามบทบาท) — ทุกบทบาทเห็น
  - จำนวนโครงการทั้งหมด (ตามช่วงวันที่และขอบเขตสิทธิ์) — ทุกบทบาทเห็น
  - จำนวนสินค้า (นับจากตาราง `products`) — ทุกบทบาทเห็น
- การ์ดสรุปสถานะโครงการแบบนับจำนวน (Win, กำลังดำเนินการ, Loss, Canceled)
  - แสดงเฉพาะเมื่อ `can_view_financial = true` (Engineer ไม่เห็น)
- สรุปการเงินรวม (แสดงเป็นการ์ด)
  - ยอดขายรวม (No VAT), ต้นทุนรวม (No VAT), กำไรรวม (No VAT), กำไรเป็นเปอร์เซ็นต์ (No VAT)
  - เฉพาะเมื่อ `can_view_financial = true` (Engineer ไม่เห็น)
- สรุปการเงินเฉพาะสถานะ “ชนะ (Win)” (การ์ด 4 ใบ)
  - Win ยอดขายรวม (No VAT), Win ต้นทุนรวม (No VAT), Win กำไรรวม (No VAT), Win กำไรเป็นเปอร์เซ็นต์ (No VAT)
  - เฉพาะเมื่อ `can_view_financial = true` (Engineer ไม่เห็น)
- กราฟ (Chart.js)
  - ยอดขายรายปี (bar): เฉพาะเมื่อ `can_view_financial = true`
  - ยอดขายรายเดือน (line): เฉพาะเมื่อ `can_view_financial = true`
  - ยอดขายรายทีม (bar): เฉพาะเมื่อ `can_view_financial = true`
  - ยอดขายของพนักงาน Top 10 (bar แนวนอน): เฉพาะเมื่อ `can_view_financial = true`
  - สถานะโครงการ (pie/doughnut): ทุกบทบาทเห็น
  - Product ที่ขายดีที่สุด (bar แนวนอน): ทุกบทบาทเห็น

## การตีความป้ายกำกับ (Label) ที่ขึ้นกับบทบาท
- ป้ายจำนวนทีม (`$team_label`)
  - Executive: “จำนวนทีมทั้งหมด”
  - อื่น ๆ: “จำนวนทีมที่ฉันอยู่”
- ป้ายจำนวนสมาชิก (`$member_label`)
  - Executive, Sale Supervisor: “จำนวนคนทั้งหมด” (ในขอบเขตที่เลือก)
  - Seller, Engineer: “จำนวนคนในทีมของฉัน”

## การกรองข้อมูลและลำดับความสำคัญ
ทุกการคิวรีหลักยึดลำดับการกรองเดียวกัน (ขึ้นกับสิทธิ์และค่าที่เลือก/สถานะทีมปัจจุบัน):
1) หากเลือกผู้ใช้ (`filter_user_id`) ให้จำกัดข้อมูลตามผู้ใช้นั้นทันที
2) หากเป็น Executive และเลือกทีม (`filter_team_id`) ให้จำกัดตามทีมนั้น
3) หากเป็น Sale Supervisor ให้จำกัดตามทีมปัจจุบันในเซสชัน (โหมด ALL คือรวมทุกทีมของตน)
4) หากเป็น Seller/Engineer ให้จำกัดเฉพาะข้อมูลของผู้ใช้ปัจจุบัน

## หมายเหตุเพิ่มเติม
- Team Switcher ใน Navbar จะปรากฏเมื่อผู้ใช้สังกัดมากกว่า 1 ทีม และมีผลต่อข้อมูลของ Sale Supervisor โดยตรง (โหมด ‘ALL’ คือรวมทุกทีมของตน)
- ช่วงวันที่เริ่มต้นของ Dashboard คือ ต้นปีปัจจุบันถึงวันที่วันนี้ และสามารถปรับได้จากตัวเลือก Date Range
- การเงิน (การ์ดและกราฟที่มีมูลค่า/ยอดขาย/กำไร) จะไม่แสดงให้ Engineer

## ผลของตัวกรอง (Filters) และข้อยกเว้น
- ลำดับความสำคัญ: เลือกผู้ใช้ (user) จะมีผลเหนือการเลือกทีม (team) เสมอ
- ตัวกรองช่วงวันที่ มีผลต่อคิวรี/การ์ด/กราฟที่อิง `sales_date` ทั้งหมด (เช่น จำนวนโครงการ, การเงินรวม, การ์ด Win, สถานะโครงการ, Top Products, ยอดขายรายปี/เดือน, ยอดขายรายทีม/รายพนักงาน)
- ไม่ได้รับผลจากตัวกรองช่วงวันที่: จำนวนสินค้า (นับจาก `products`), จำนวนทีม/จำนวนสมาชิกทีม (อิงบทบาท/ทีมที่สังกัด ไม่อิงช่วงวัน)
- Executive: เลือกทีม/ผู้ใช้จากฟอร์มได้ และผลจะสะท้อนในทุกส่วนที่รองรับการกรอง
- Sale Supervisor: ใช้ Team Switcher (ALL = รวมทุกทีมของตน หรือทีมที่เลือกปัจจุบัน)
- Seller/Engineer: ไม่มีตัวกรองทีม/ผู้ใช้บนฟอร์ม และระบบจำกัดข้อมูลตาม `user_id` ของตนเองโดยตรง
  - หากสังกัดหลายทีม ข้อมูลของตนจะถูกรวม “ทุกทีมของผู้ใช้คนนั้น” (Team Switcher ไม่มีผลกับ 2 บทบาทนี้)
